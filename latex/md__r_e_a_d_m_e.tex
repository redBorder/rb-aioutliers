\chapter{rb-\/aioutliers Main package}
\hypertarget{md__r_e_a_d_m_e}{}\label{md__r_e_a_d_m_e}\index{rb-\/aioutliers Main package@{rb-\/aioutliers Main package}}
\label{md__r_e_a_d_m_e_autotoc_md0}%
\Hypertarget{md__r_e_a_d_m_e_autotoc_md0}%
    \href{https://www.gnu.org/licenses/gpl-2.0}{\texttt{ }} \href{https://codecov.io/gh/redBorder/rb-aioutliers}{\texttt{ }} \href{https://app.fossa.com/projects/git\%2Bgithub.com\%2FredBorder\%2Frb-aioutliers?ref=badge_shield}{\texttt{ }}

\href{https://app.fossa.com/projects/git\%2Bgithub.com\%2FredBorder\%2Frb-aioutliers?ref=badge_large}{\texttt{ }}

Main package to install redborder AI outliers in Rocky Linux 9\hypertarget{md__r_e_a_d_m_e_autotoc_md1}{}\doxysubsubsection{\texorpdfstring{Platforms}{Platforms}}\label{md__r_e_a_d_m_e_autotoc_md1}

\begin{DoxyItemize}
\item Rocky Linux 9
\end{DoxyItemize}\hypertarget{md__r_e_a_d_m_e_autotoc_md2}{}\doxysection{\texorpdfstring{Installation}{Installation}}\label{md__r_e_a_d_m_e_autotoc_md2}

\begin{DoxyEnumerate}
\item yum install epel-\/release \&\& rpm -\/ivh \href{http://repo.redborder.com/redborder-repo-0.0.3-1.el7.rb.noarch.rpm}{\texttt{ http\+://repo.\+redborder.\+com/redborder-\/repo-\/0.\+0.\+3-\/1.\+el7.\+rb.\+noarch.\+rpm}}
\item yum install rb-\/aioutliers
\end{DoxyEnumerate}\hypertarget{md__r_e_a_d_m_e_autotoc_md3}{}\doxysection{\texorpdfstring{Model design}{Model design}}\label{md__r_e_a_d_m_e_autotoc_md3}
Initially, data is extracted from a designated druid datasource in timeseries format, with configurable metrics and settings. After rescaling from zero to one and segmentation, an autoencoder reconstructs the data, enabling anomaly detection through k-\/sigma thresholding. The anomalies are outputed in Json format together with the data reconstructed by the autoencoder.\hypertarget{md__r_e_a_d_m_e_autotoc_md4}{}\doxysection{\texorpdfstring{Model execution}{Model execution}}\label{md__r_e_a_d_m_e_autotoc_md4}
rb-\/aioutliers utilizes the Flask framework to create an HTTP server. Users can send Druid queries via POST requests to the /calculate endpoint. When rb-\/aioutliers receives the Druid query, it sends a request to the Druid broker, retrieves the necessary data, and then proceeds to execute the anomaly detection model.



After executing the model, the server can respond with one of two status messages\+:

{\ttfamily HTTP OK 200 Success}\+: In this case, the response body will be structured as follows\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ "{}status"{}:\ "{}success"{},}
\DoxyCodeLine{\ \ \ \ "{}anomalies"{}:\ [Array\_of\_anomalies],}
\DoxyCodeLine{\ \ \ \ "{}prediction"{}:\ [Array\_of\_predictions]}
\DoxyCodeLine{\}}

\end{DoxyCode}


{\ttfamily HTTP 500 Internal Server Error}\+: If there is an issue during the process, the response will contain an error message\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ "{}status"{}:\ "{}error"{},}
\DoxyCodeLine{\ \ \ \ "{}msg"{}:\ "{}Error\_description\_message"{}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md__r_e_a_d_m_e_autotoc_md5}{}\doxysection{\texorpdfstring{Model training}{Model training}}\label{md__r_e_a_d_m_e_autotoc_md5}
The rb-\/aioutliers service generates a custom Druid query and sends it to the Redborder cluster Druid broker. After sending the query, it retrieves the data and attempts to train a model with custom parameters such as epochs or batch size. Once the model training is complete, it outputs a backup file and the generated Keras model.

\hypertarget{md__r_e_a_d_m_e_autotoc_md6}{}\doxysection{\texorpdfstring{Clusterization with Chef, Consul, AWS S3 \& Redis}{Clusterization with Chef, Consul, AWS S3 \& Redis}}\label{md__r_e_a_d_m_e_autotoc_md6}
The rb-\/aioutliers service can operate in cluster mode! This is achieved by dividing the service into two components\+: the executor and the trainer.\hypertarget{md__r_e_a_d_m_e_autotoc_md7}{}\doxysection{\texorpdfstring{Executor}{Executor}}\label{md__r_e_a_d_m_e_autotoc_md7}
The executor service is registered in Hashi\+Corp Consul. When the Redborder Web\+UI sends a request to api/v1/outliers, it will be directed to the rb-\/aioutliers.\+service, which, in turn, will redirect the request to any of the nodes running the rb-\/aioutliers REST server. This server will download the relevant model from S3, based on the sensor specified in the Druid query, and execute it.

\hypertarget{md__r_e_a_d_m_e_autotoc_md8}{}\doxysection{\texorpdfstring{Trainer}{Trainer}}\label{md__r_e_a_d_m_e_autotoc_md8}
For the training service, the Chef client will create individual configuration files for each node, which are generated based on the cookbook and templates. These configuration files specify which sensor should be trained for. The rb-\/aioutliers-\/train service will then proceed to ({\bfseries{take a look at Trainer jobs below}}) download the appropriate model from S3 for each node. Once the training is completed, the rb-\/aioutliers-\/train service will upload the resulting trained model to S3. It\textquotesingle{}s important to note that each model is unique and specific to the corresponding sensor.

\hypertarget{md__r_e_a_d_m_e_autotoc_md9}{}\doxysection{\texorpdfstring{Trainer Jobs}{Trainer Jobs}}\label{md__r_e_a_d_m_e_autotoc_md9}
The trainer nodes send job data to a Redis server (this is done by the {\ttfamily Trainer service}). Each node also requests the job queue. The RQ worker processes these jobs in the background. If any node goes down, there will be no problem, as the sensor information for training is stored in Redis, and another node can take over its tasks.



For more info about deploy with Chef Server take a look at \href{https://github.com/redBorder/cookbook-rb-aioutliers}{\texttt{ Outliers Cookbook}}\hypertarget{md__r_e_a_d_m_e_autotoc_md10}{}\doxysubsection{\texorpdfstring{Docker support}{Docker support}}\label{md__r_e_a_d_m_e_autotoc_md10}
If you want to run the app inside a docker container run the following commands


\begin{DoxyCode}{0}
\DoxyCodeLine{cd\ ./resources/src}
\DoxyCodeLine{docker-\/compose\ up\ -\/-\/build\ -\/d}

\end{DoxyCode}


now if you list your docker container you will see the following container running.

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{6}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Container ID   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Image   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Command   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Created   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Status   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Exposed Ports    }\\\cline{1-6}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Container ID   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Image   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Command   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Created   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Status   }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Exposed Ports    }\\\cline{1-6}
\endhead
cb18a72ab60e   &src\+\_\+rb\+\_\+aioutliers\+\_\+rest   &python {\bfseries{main}}.py   &3 minutes ago   &Up 3 minutes   &0.\+0.\+0.\+0\+:39091-\/\texorpdfstring{$>$}{>}39091/tcp, \+::\+:39091-\/\texorpdfstring{$>$}{>}39091/tcp   \\\cline{1-6}
\end{longtabu}
\hypertarget{md__r_e_a_d_m_e_autotoc_md11}{}\doxysubsection{\texorpdfstring{API Endpoints}{API Endpoints}}\label{md__r_e_a_d_m_e_autotoc_md11}
\hypertarget{md__r_e_a_d_m_e_autotoc_md12}{}\doxysubsubsection{\texorpdfstring{{\ttfamily /calculate}}{{\ttfamily /calculate}}}\label{md__r_e_a_d_m_e_autotoc_md12}

\begin{DoxyItemize}
\item {\bfseries{HTTP Method\+:}} POST
\item {\bfseries{Description\+:}} Initiates anomaly detection (model execution) with a Druid query.
\item {\bfseries{Request Body\+:}} JSON data containing the Druid query in base64 string.
\end{DoxyItemize}

{\bfseries{Example Request\+:}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\ -\/x-\/www-\/form-\/urlencoded}
\DoxyCodeLine{POST\ /calculate\ (application-\/x-\/www-\/form-\/urlencoded)}
\DoxyCodeLine{query=base64\_string}

\end{DoxyCode}
 {\bfseries{Example Druid Query\+:}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ "{}dataSource"{}:\ "{}rb\_flow"{},}
\DoxyCodeLine{\ \ "{}granularity"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}type"{}:\ "{}period"{},}
\DoxyCodeLine{\ \ \ \ "{}period"{}:\ "{}pt1m"{},}
\DoxyCodeLine{\ \ \ \ "{}origin"{}:\ "{}2023-\/09-\/21T09:00:00Z"{}}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ "{}intervals"{}:\ [}
\DoxyCodeLine{\ \ \ \ "{}2023-\/09-\/21T09:00:00+00:00/2023-\/09-\/21T10:00:00+00:00"{}}
\DoxyCodeLine{\ \ ],}
\DoxyCodeLine{\ \ "{}filter"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}type"{}:\ "{}selector"{},}
\DoxyCodeLine{\ \ \ \ "{}dimension"{}:\ "{}sensor\_name"{},}
\DoxyCodeLine{\ \ \ \ "{}value"{}:\ "{}FlowSensor"{}}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ "{}queryType"{}:\ "{}timeseries"{},}
\DoxyCodeLine{\ \ "{}context"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}timeout"{}:\ 90000,}
\DoxyCodeLine{\ \ \ \ "{}skipEmptyBuckets"{}:\ "{}true"{}}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ "{}limitSpec"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}type"{}:\ "{}default"{},}
\DoxyCodeLine{\ \ \ \ "{}limit"{}:\ 100,}
\DoxyCodeLine{\ \ \ \ "{}columns"{}:\ []}
\DoxyCodeLine{\ \ \},}
\DoxyCodeLine{\ \ "{}aggregations"{}:\ [}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}type"{}:\ "{}longSum"{},}
\DoxyCodeLine{\ \ \ \ \ \ "{}name"{}:\ "{}bytes"{},}
\DoxyCodeLine{\ \ \ \ \ \ "{}fieldName"{}:\ "{}sum\_bytes"{}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ ],}
\DoxyCodeLine{\ \ "{}postAggregations"{}:\ []}
\DoxyCodeLine{\}}

\end{DoxyCode}
 {\bfseries{Example Respone\+:}} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ "{}anomalies"{}:\ [}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 36453984.6858499,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:00:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}expected"{}:\ 45825798.264862545,}
\DoxyCodeLine{\ \ \ \ \ \ "{}timestamp"{}:\ "{}2023-\/09-\/28T07:01:00.000Z"{}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ ],}
\DoxyCodeLine{\ \ "{}status"{}:\ "{}success"{}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md__r_e_a_d_m_e_autotoc_md13}{}\doxysubsection{\texorpdfstring{Contributing}{Contributing}}\label{md__r_e_a_d_m_e_autotoc_md13}

\begin{DoxyEnumerate}
\item Fork the repository on Github
\item Create a named feature branch (like {\ttfamily add\+\_\+component\+\_\+x})
\item Write your change
\item Write tests for your change (if applicable)
\item Run the tests, ensuring they all pass
\item Submit a Pull Request using Github
\end{DoxyEnumerate}\hypertarget{md__r_e_a_d_m_e_autotoc_md14}{}\doxysubsection{\texorpdfstring{License and Authors}{License and Authors}}\label{md__r_e_a_d_m_e_autotoc_md14}

\begin{DoxyItemize}
\item Miguel Álvarez Adsuara \href{mailto:malvarez@redborder.com}{\texttt{ malvarez@redborder.\+com}}
\item Pablo Rodriguez Flores \href{mailto:prodriguez@redborder.com}{\texttt{ prodriguez@redborder.\+com}}
\end{DoxyItemize}

LICENSE\+: GENERAL PUBLIC LICENSE, Version 2, June 1991 